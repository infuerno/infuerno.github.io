I"®!<h2 id="introduction">Introduction</h2>

<p>Chef is a ruby framework for automating, reusing and documenting server configuration.</p>

<p>An important idea is <em>idempotence</em> meaning you can run a script several times, but if it has already been run, it won‚Äôt change anything</p>

<p>Adam Wiggans: <a href="http://12factor.net/">http://12factor.net/</a></p>

<p>Other tools: Puppet, CFEngine</p>

<h2 id="terminology">Terminology</h2>

<p>:node
A host where the chef client will run</p>

<p>:Chef client
The comman line program that configures the servers. You will often log into the server and run the client from the command line on that node.</p>

<p>:Chef server
Stores information about the nodes. REST based.</p>

<p>:Chef solo
A standalone version of the client which doesn‚Äôt use a server</p>

<p>:recipes
A single file of Ruby code that contains commands to run on a node</p>

<p>:resources
A node‚Äôs resouces includes files, directories, users and services</p>

<p>:cookbook
A collection of recipes</p>

<p>:roles
Concept chef uses to group specific functionality e.g. web role, database role</p>

<p>:runlist
An array of recipes and roles defining what gets run on that server</p>

<p>:attributes
variables which get passed into recipes and templates e.g. version of software to install</p>

<p>:template
erb file similar to a rails view usually used to create and update configuration files</p>

<p>:notification
When a resouce is changed it can trigger an update in another resource</p>

<h2 id="using-virtualbox-and-vagrant">Using VirtualBox and Vagrant</h2>

<ol>
  <li>git clone</li>
  <li><code class="highlighter-rouge">cd</code> into directory</li>
  <li><code class="highlighter-rouge">vagrant up</code> to download the .box image, configure and start it</li>
  <li><code class="highlighter-rouge">vagrant ssh</code> to ssh into the server as the vagrant user</li>
  <li><code class="highlighter-rouge">ruby -v</code> and <code class="highlighter-rouge">gem -v</code> to check that ruby and rubygems are both installed</li>
</ol>

<h2 id="writing-a-simple-cookbook-and-recipe">Writing a simple cookbook and recipe</h2>

<ol>
  <li>Create a directory for the cookbook (Nginx)</li>
  <li>Create directories for recipes, attributes and templates</li>
  <li>Create a default.rb in the recipes directory - default recipe is a good place to set up the service or process and master configuration template - a default recipe shouldn‚Äôt do much more than this</li>
  <li>First need to install the nginx package itself e.g. with debian this would be <code class="highlighter-rouge">apt-get nginx</code>. The chef directive <code class="highlighter-rouge"><span class="k">package</span> <span class="s2">"nginx"</span></code> will figure out how to install this package on this os. Specify a version if really necessary.</li>
  <li>Secondly we want to start, stop and restart the nginx server, so need to install as a service. This can be done using the chef directive <code class="highlighter-rouge">service "nginx"</code>.</li>
  <li>We also want to get the status, start and reload the service, so it must support these.</li>
  <li>We also want the service to ‚Äúbe started‚Äù when the os boots and also when chef runs. Normally need to check run levels etc, but with chef the <code class="highlighter-rouge">action</code> directive can be passed an array with <code class="highlighter-rouge">:enable</code> to make sure it is started when the os starts and <code class="highlighter-rouge">:start</code> to ensure chef will start nginx if it isn‚Äôt already running</li>
  <li>To configure the .conf file for nginx, it is best to start with the default .conf. For this it may be necessary to manually install nginx to see this default file, then write the chef recipe to modify it, then run the whole chef install to check it all works correctly - good to use virtual machines in this instance. The <code class="highlighter-rouge">template</code> block can take further directives to e.g. restart the service anytime the config file is updated</li>
</ol>

<h2 id="running-chef">Running chef</h2>

<ol>
  <li>Install chef solo using a ruby gem <code class="highlighter-rouge">gem install chef --no-rdoc --no-ri</code></li>
  <li>Run <code class="highlighter-rouge">chef-solo</code></li>
</ol>

<h3 id="attributes">Attributes</h3>

<p>Attributes or variables are applied according to a hierarchy.</p>

<p>Cookbook &gt; Environment &gt; Role &gt; Node</p>

<ol>
  <li>Cookbook attributes give good default attributes e.g. 5 worker processes for Nginx</li>
  <li>Environment attributes can override this, e.g. 1 worker process for a development environment</li>
  <li>Role attributes override environment attributes - a web server may actually need 6 worker process for Nginx to handle all the requests</li>
  <li>Finally node attributes override everything else, e.g. web server 42 is older and should only define 2 worker processes</li>
</ol>

<p>Default &gt; Normal / (Set) &gt; Override &gt; Automatic</p>

<p>Most people name their cookbook attribute files <code class="highlighter-rouge">default.rb</code> but this could get confusing with all the other things called default. All files in a cookbook get loaded, so you are free to call your file anything you like.</p>

<p>This file contains cookbook default attributes. Default attributes are usually all that is required.</p>

<p>Attributes can be defined using ruby symbols, strings or dot notation:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>default[:nginx][:worker_processes] = 4
default["nginx"][:worker_processes] = 4
default.nginx[:worker_processes] = 4
</code></pre></div></div>

<p>This attribute can be referred to in the template file using the following syntax:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= @node[:nginx][:worker_processes] %&gt;
</code></pre></div></div>

<p>The @node object holds all the attributes, defined either on a cookbook, environment, role or node.</p>

<p>An alternative is to define the variable directly in the recipe in the parameters which get passed to the template. HOWEVER, default attributes are preferred over variables.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>template "/etc/nginx/nginx.conf" do
    source "nginx.conf.erb" # chef will automatically look for this, so this is not required unless we are not using the default
    notifies :reload, "service[nginx]"
    variables :user =&gt; "www-data"
end
</code></pre></div></div>

<p>Try not to go overboard replacing all values in template files with attributes. Defaults are often good enough.</p>

<h3 id="providers-and-resources">Providers and Resources</h3>

<p>Seldomly used, but useful for auxillary configurations e.g. nginx virtual hosts. Used to create LWRPs (Light Weight Resource Providers).</p>

<h2 id="add-an-ssh-key-to-a-virtual-server">Add an SSH key to a Virtual Server</h2>

<p>Copy your own ssh key (in ~/.ssh/) to the clipboard <code class="highlighter-rouge">pbcopy &lt; ~/.ssh/id_rsa.pub</code> and paste it into the authorised keys on the vagrant box (in ~/.ssh/authorized_keys)</p>

<h2 id="write-a-recipe-everything-required-for-serving-a-rails-app">Write a recipe (everything required for serving a rails app)</h2>

<p>Deploying rails app requires many config files (Nginx virtual hosts file, app server config file such as Passenger or Unicorn). This will be done with a single recipe.</p>

<h3 id="check-the-unicorn-recipe">Check the unicorn recipe</h3>

<p>The unicorn recipe does 3 things:</p>
<ol>
  <li>Installs the unicorn gem package via chef (could also be done using the rails app itself and bundler)</li>
  <li>Creates a directory to store unicorn configuration files</li>
  <li>Installs a cookbook file i.e. a static file, stored in the cookbook which can be copied to the node</li>
</ol>

<h3 id="write-the-rails-recipe">Write the rails recipe</h3>

<ol>
  <li>Create a directory for the cookbook (Rails)</li>
  <li>Create directories for recipes, attributes and templates</li>
  <li>Create a default recipe which will need to:
 i. run the Nginx and Unicorn installers - <code class="highlighter-rouge">include_recipe "nginx"</code>
 ii. create a metadata file to define dependencies (similar to bundler) - typically only used in chef server, but good practise to include for chef solo too
 iii. include bundler and create some directories
 iv. configure the unicorn app server
 v. configure nginx to serve the application as a virtual host</li>
</ol>

:ET